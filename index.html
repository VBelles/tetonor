<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetonor</title>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header Styling */
        .game-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .game-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.025em;
            color: #1a1a1a;
        }

        .badge-group {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        .badge {
            padding: 0.4rem 1.2rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background-color: #2563eb;
            color: white;
        }

        .badge-secondary {
            background-color: #64748b;
            color: white;
        }

        /* Toolbar / Buttons */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .btn-group {
            display: flex;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .btn {
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-outline {
            background: white;
            color: #1a1a1a;
        }

        .btn-outline:hover {
            background: #f8fafc;
        }

        .btn-outline.active {
            background: #1e293b;
            color: white;
        }

        .btn-dark {
            background: #1e293b;
            color: white;
        }

        .btn-dark:hover {
            background: #0f172a;
        }

        .btn-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .btn-info {
            background: #e0f2fe;
            color: #075985;
        }

        .btn-info:hover {
            background: #d0e7ff;
        }

        .btn-success {
            background: #059669;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        /* Puzzle Board */
        .puzzle-board {
            width: 800px;
            max-width: 100%;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #000;
            border: 3px solid #000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .grid-cell {
            background-color: white;
            height: 120px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .grid-number {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 500;
            color: #334155;
        }

        .grid-inputs {
            display: flex;
            width: 100%;
            border-top: 1px solid #000;
        }

        .grid-inputs input,
        .grid-inputs select {
            flex: 1;
            width: 0;
            min-width: 0;
            height: 44px;
            border: none;
            border-right: 1px solid #000;
            text-align: center;
            font-size: 1.1rem;
            background: transparent;
            font-family: inherit;
        }

        .grid-inputs select {
            flex: 0 0 55px;
            cursor: pointer;
        }

        .grid-inputs input:last-child {
            border-right: none;
        }

        /* Strip Styling */
        .strip-container {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 1px;
            background-color: #000;
            border: 3px solid #000;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .strip-cell {
            height: 60px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            position: relative;
        }

        .strip-cell.locked {
            background-color: #f1f5f9;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .strip-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 1.25rem;
            color: #2563eb;
            font-family: inherit;
        }

        /* Callout */
        .callout {
            background-color: #eff6ff;
            border-left: 6px solid #3b82f6;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 3.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .callout-title {
            font-weight: 700;
            font-size: 1rem;
            margin: 0 0 0.75rem 0;
            color: #1e3a8a;
        }

        .callout-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .callout-list li {
            margin-bottom: 0.4rem;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }



        /* Validation Colors */
        .correct {
            background-color: #dcfce7 !important;
        }

        .incorrect {
            background-color: #fee2e2 !important;
        }

        /* Language Switcher */
        .lang-switch {
            position: absolute;
            top: 2rem;
            right: 2rem;
            display: flex;
            gap: 0.5rem;
        }

        .lang-btn {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 600;
        }

        .lang-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
        }

        /* Focus States */
        input:focus,
        select:focus {
            z-index: 10;
            outline: none;
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        /* Mobile Adjustments */
        @media (max-width: 820px) {
            .main-container {
                padding: 1rem 0.5rem;
            }

            .game-header {
                margin-bottom: 1rem;
            }

            .game-title {
                font-size: 2.5rem;
            }

            .toolbar {
                margin-bottom: 1.5rem;
                gap: 0.5rem;
            }

            .puzzle-board {
                width: 100%;
            }

            .grid-cell {
                height: 90px;
            }

            .grid-number {
                font-size: 1.5rem;
            }

            .grid-inputs input,
            .grid-inputs select {
                height: 40px;
                font-size: 1rem;
            }

            .grid-inputs select {
                flex: 0 0 35px;
            }

            .strip-container {
                grid-template-columns: repeat(8, 1fr);
                margin-top: 1rem;
                gap: 1px;
            }

            .strip-cell {
                height: 45px;
            }

            .strip-cell.locked,
            .strip-input {
                font-size: 1rem;
            }

            .callout {
                margin-top: 2rem;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 2rem;
            }

            .grid-cell {
                height: 80px;
            }

            .grid-number {
                font-size: 1.25rem;
            }

            .grid-inputs input,
            .grid-inputs select {
                height: 36px;
                font-size: 0.9rem;
            }

            .grid-inputs select {
                flex: 0 0 30px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="lang-switch">
            <button onclick="setLanguage('en')" id="lang-en" class="lang-btn">EN</button>
            <button onclick="setLanguage('es')" id="lang-es" class="lang-btn">ES</button>
        </div>

        <header class="game-header">
            <h1 class="game-title" data-i18n="title">Tetonor</h1>
            <div class="badge-group">
                <span id="difficulty-badge" class="badge badge-primary"></span>
                <span id="seed-badge" class="badge badge-secondary"></span>
            </div>
        </header>

        <nav class="toolbar">
            <div class="btn-group">
                <button id="diff-easy" class="btn btn-outline" data-i18n="easy">Easy</button>
                <button id="diff-medium" class="btn btn-outline " data-i18n="medium">Medium</button>
                <button id="diff-hard" class="btn btn-outline" data-i18n="hard">Hard</button>
            </div>
            <div class="btn-group">
                <button id="prev-btn" class="btn btn-dark" data-i18n="prev">‚Üê Prev</button>
                <button id="next-btn" class="btn btn-dark" data-i18n="next">Next ‚Üí</button>
            </div>
            <div class="btn-group">
                <button id="reset-btn" class="btn btn-danger" data-i18n="reset">‚Ü∫ Reset</button>
                <button id="solve-btn" class="btn btn-info" data-i18n="solve">‚ú® Solve</button>
            </div>
            <button id="check-btn" class="btn btn-success" data-i18n="checkSolution">‚úì Check Solution</button>
        </nav>

        <section class="puzzle-board">
            <div id="grid" class="grid-container"></div>
            <div id="strip" class="strip-container"></div>
        </section>

        <aside class="callout">
            <h6 class="callout-title" data-i18n="howToPlay">How to Play</h6>
            <ul class="callout-list">
                <li>üìã <strong data-i18n="objectiveLabel">Objective:</strong> <span data-i18n="objectiveDesc">Form the
                        16 grid numbers using 8 pairs from the strip.</span></li>
                <li>‚ûï <strong data-i18n="equationsLabel">Equations:</strong> <span data-i18n="equationsDesc">Each grid
                        number = (Number A) <strong>+</strong> or <strong>√ó</strong> (Number B).</span></li>
                <li>üîÑ <strong data-i18n="twiceRuleLabel">The Twice Rule:</strong> <span data-i18n="twiceRuleDesc">Each
                        pair must be used <strong>exactly twice</strong>: once for addition (+) and once for
                        multiplication (√ó).</span></li>
                <li>üìè <strong data-i18n="stripOrderLabel">Strip Order:</strong> <span data-i18n="stripOrderDesc">All 16
                        strip numbers are <strong>sorted in ascending order</strong>, numbers can be repeated.</span>
                </li>
            </ul>
        </aside>
    </div>

    <script src="translations.js"></script>
    <script src="generator.js"></script>
    <script src="validator.js"></script>
    <script src="solver.js"></script>

    <script>
        const ALPHA = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_";

        const appState = {
            puzzle: null,
            seed: null,
            difficulty: null,
            lang: localStorage.getItem('tetonor_lang') || getBrowserLang()
        };

        function getBrowserLang() {
            return (navigator.language || 'en').startsWith('es') ? 'es' : 'en';
        }

        function init() {
            bindGlobalEvents();
            updateLanguageButtons(appState.lang);
            handleRoute();
        }

        // --- Routing & Navigation ---

        function handleRoute() {
            const { seed, difficulty, stateEncoded } = parseHash();

            // Should we regenerate?
            const isDifferent = seed !== appState.seed || difficulty !== appState.difficulty || !appState.puzzle;

            appState.seed = seed;
            appState.difficulty = difficulty;

            if (isDifferent) {
                appState.puzzle = TetonorGenerator.generate(seed, difficulty);
                renderBoard(appState.puzzle);
            }

            // Always update UI metadata
            renderHeader(appState);
            updateDifficultyButtons(appState.difficulty);

            // Load Inputs
            const savedFromStorage = localStorage.getItem(`tetonor_${difficulty}_${seed}`);
            const savedData = stateEncoded || savedFromStorage;
            const decoded = savedData && decodeState(savedData);

            if (decoded) {
                fillInputs(decoded);
                // If we loaded from storage but URL doesn't have it, update URL silent replace
                if (!stateEncoded && savedFromStorage) {
                    const hash = `#${difficulty}/${seed}/${savedFromStorage}`;
                    history.replaceState(null, null, hash);
                } else if (stateEncoded && !savedFromStorage) {
                    localStorage.setItem(`tetonor_${appState.difficulty}_${appState.seed}`, stateEncoded);
                }
            }
        }


        function parseHash() {
            const [diffStr, seedStr, stateStr] = window.location.hash.slice(1).split('/');
            const difficulty = ['easy', 'medium', 'hard'].includes(diffStr) ? diffStr : 'easy';
            const seed = parseInt(seedStr) || 1;
            return { difficulty, seed, stateEncoded: stateStr || null };
        }

        function navigate(offset) {
            const newSeed = Math.max(1, appState.seed + offset);
            window.location.hash = `#${appState.difficulty}/${newSeed}`;
        }

        function setDifficulty(diff) {
            window.location.hash = `#${diff}/${appState.seed}`;
        }

        // --- Logic & Actions ---

        function checkSolution() {
            clearFeedback();
            const { strip, grid } = captureInputs();

            const stripInputs = strip.map((v, i) => appState.puzzle.strip[i] === null ? parseInt(v) : null);
            const gridInputs = grid.map(g => ({
                num1: parseInt(g.num1),
                op: g.op,
                num2: parseInt(g.num2)
            }));

            const result = TetonorValidator.validate(appState.puzzle, { stripInputs, gridInputs });
            showFeedback(result);

            const t = translations[appState.lang];
            alert(result.success ? t.validationSuccess : t.validationIncomplete);
        }

        function revealSolution() {
            clearFeedback();
            const t = translations[appState.lang];
            if (!confirm(t.solveConfirm || "Revelar soluci√≥n? / Reveal solution?")) return;

            const solution = TetonorSolver.solve(appState.puzzle.grid, appState.puzzle.strip);
            if (solution) {
                fillInputs(solution);
                saveCurrentState();
            } else {
                alert(t.solveError);
            }
        }

        function resetPuzzle() {
            const t = translations[appState.lang];
            if (confirm(t.confirmReset)) {
                localStorage.removeItem(`tetonor_${appState.difficulty}_${appState.seed}`);
                window.location.hash = `#${appState.difficulty}/${appState.seed}`;
            }
        }

        // --- DOM / UI Rendering ---

        function renderHeader(state) {
            const t = translations[state.lang];
            document.getElementById('difficulty-badge').textContent = t[state.difficulty].toUpperCase();
            document.getElementById('seed-badge').textContent = `${t.seed}: ${state.seed}`;
        }

        function updateDifficultyButtons(difficulty) {
            document.querySelectorAll('.btn-outline').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.i18n === difficulty);
            });
        }

        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn =>
                btn.classList.toggle('active', btn.id === `lang-${lang}`));
        }

        function renderBoard(puzzle) {
            document.getElementById('grid').innerHTML = puzzle.grid.map((val, i) => `
                <div class="grid-cell">
                    <div class="grid-number">${val}</div>
                    <div class="grid-inputs">
                        <input type="number" id="grid_${i}_num1">
                        <select id="grid_${i}_op">
                            <option value=""></option>
                            <option value="+">+</option>
                            <option value="√ó">√ó</option>
                        </select>
                        <input type="number" id="grid_${i}_num2">
                    </div>
                </div>`).join('');

            document.getElementById('strip').innerHTML = puzzle.strip.map((val, i) =>
                val !== null
                    ? `<div class="strip-cell locked">${val}</div>`
                    : `<div class="strip-cell"><input type="number" id="strip_${i}" class="strip-input"></div>`
            ).join('');

            // Bind input changes to state saver
            document.querySelectorAll('input, select').forEach(el =>
                el.addEventListener('input', () => saveCurrentState()));
        }

        function applyTranslations(lang) {
            const t = translations[lang];
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerHTML = t[el.dataset.i18n] || el.dataset.i18n;
            });
        }

        function setLanguage(lang) {
            appState.lang = lang;
            localStorage.setItem('tetonor_lang', lang);
            applyTranslations(lang);
            renderHeader(appState);
            updateLanguageButtons(lang);
        }

        // --- Persistence Helpers ---

        function saveCurrentState() {
            const inputs = captureInputs();
            const encoded = encodeState(inputs);
            localStorage.setItem(`tetonor_${appState.difficulty}_${appState.seed}`, encoded);

            const hash = `#${appState.difficulty}/${appState.seed}${encoded ? '/' + encoded : ''}`;
            history.replaceState(null, null, hash);
        }

        function captureInputs() {
            const strip = Array.from({ length: 16 }, (_, i) => {
                return document.getElementById(`strip_${i}`)?.value || "";
            });
            const grid = Array.from({ length: 16 }, (_, i) => {
                return {
                    num1: document.getElementById(`grid_${i}_num1`)?.value || "",
                    op: document.getElementById(`grid_${i}_op`)?.value || "",
                    num2: document.getElementById(`grid_${i}_num2`)?.value || ""
                };
            });
            return { strip, grid };
        }

        function fillInputs(data) {
            data.strip?.forEach((val, i) => {
                const el = document.getElementById(`strip_${i}`);
                if (el) el.value = val ?? "";
            });

            data.grid?.forEach((cell, i) => {
                ['num1', 'op', 'num2'].forEach(key => {
                    const el = document.getElementById(`grid_${i}_${key}`);
                    if (el) el.value = cell[key] || "";
                });
            });
        }

        function encodeState({ strip, grid }) {
            const inputs = [...strip, ...grid.flatMap(g => [g.num1, g.op, g.num2])];
            const sparse = [];
            inputs.forEach((val, i) => {
                if (val && val !== "") {
                    let v = val === "+" ? "p" : (val === "√ó" ? "m" : val);
                    sparse.push(ALPHA[i] + v);
                }
            });
            return sparse.join(".");
        }

        function decodeState(encoded) {
            if (!encoded) return null;
            try {
                const s = Array(16).fill("");
                const g = Array(16).fill(null).map(() => ({ num1: "", op: "", num2: "" }));
                encoded.split(".").forEach(pair => {
                    const index = ALPHA.indexOf(pair[0]);
                    let val = pair.slice(1);
                    if (val === "p") val = "+";
                    if (val === "m") val = "√ó";
                    if (index < 16) s[index] = val;
                    else if (index < 64) {
                        const gIdx = index - 16;
                        const cellIdx = Math.floor(gIdx / 3);
                        const types = ["num1", "op", "num2"];
                        g[cellIdx][types[gIdx % 3]] = val;
                    }
                });
                return { strip: s, grid: g };
            } catch (e) { return null; }
        }

        function clearFeedback() {
            document.querySelectorAll('.correct, .incorrect').forEach(el =>
                el.classList.remove('correct', 'incorrect'));
        }

        function showFeedback(result) {
            result.stripFeedback?.forEach(f => {
                document.getElementById(`strip_${f.index}`)?.classList.add(f.correct ? 'correct' : 'incorrect');
            });
            result.gridFeedback?.forEach(f => {
                ['num1', 'op', 'num2'].forEach(type => {
                    document.getElementById(`grid_${f.index}_${type}`)?.classList.add(f.correct ? 'correct' : 'incorrect');
                });
            });
        }

        function bindGlobalEvents() {
            window.onhashchange = handleRoute;
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('next-btn').onclick = () => navigate(1);
            document.getElementById('reset-btn').onclick = resetPuzzle;
            document.getElementById('check-btn').onclick = checkSolution;
            document.getElementById('solve-btn').onclick = revealSolution;

            ['easy', 'medium', 'hard'].forEach(d => {
                document.getElementById(`diff-${d}`).onclick = () => setDifficulty(d);
            });
        }

        // Start 
        init();

    </script>