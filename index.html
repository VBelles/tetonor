<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetonor</title>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header Styling */
        .game-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .game-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.025em;
            color: #1a1a1a;
        }

        .badge-group {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        .badge {
            padding: 0.4rem 1.2rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background-color: #2563eb;
            color: white;
        }

        .badge-secondary {
            background-color: #64748b;
            color: white;
        }

        /* Toolbar / Buttons */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .btn-group {
            display: flex;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .btn {
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-outline {
            background: white;
            color: #1a1a1a;
        }

        .btn-outline:hover {
            background: #f8fafc;
        }

        .btn-outline.active {
            background: #1e293b;
            color: white;
        }

        .btn-dark {
            background: #1e293b;
            color: white;
        }

        .btn-dark:hover {
            background: #0f172a;
        }

        .btn-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .btn-info {
            background: #e0f2fe;
            color: #075985;
        }

        .btn-info:hover {
            background: #d0e7ff;
        }

        .btn-success {
            background: #059669;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        /* Puzzle Board */
        .puzzle-board {
            width: 800px;
            max-width: 100%;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #000;
            border: 3px solid #000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .grid-cell {
            background-color: white;
            height: 120px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .grid-number {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 500;
            color: #334155;
        }

        .grid-inputs {
            display: flex;
            width: 100%;
            border-top: 1px solid #000;
        }

        .grid-inputs input,
        .grid-inputs select {
            flex: 1;
            width: 0;
            min-width: 0;
            height: 44px;
            border: none;
            border-right: 1px solid #000;
            text-align: center;
            font-size: 1.1rem;
            background: transparent;
            font-family: inherit;
        }

        .grid-inputs select {
            flex: 0 0 55px;
            cursor: pointer;
        }

        .grid-inputs input:last-child {
            border-right: none;
        }

        /* Strip Styling */
        .strip-container {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 1px;
            background-color: #000;
            border: 3px solid #000;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .strip-cell {
            height: 60px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            position: relative;
        }

        .strip-cell.locked {
            background-color: #f1f5f9;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .strip-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 1.25rem;
            color: #2563eb;
            font-family: inherit;
        }

        /* Callout */
        .callout {
            background-color: #eff6ff;
            border-left: 6px solid #3b82f6;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 3.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .callout-title {
            font-weight: 700;
            font-size: 1rem;
            margin: 0 0 0.75rem 0;
            color: #1e3a8a;
        }

        .callout-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .callout-list li {
            margin-bottom: 0.4rem;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }



        /* Validation Colors */
        .correct {
            background-color: #dcfce7 !important;
        }

        .incorrect {
            background-color: #fee2e2 !important;
        }

        /* Focus States */
        input:focus,
        select:focus {
            z-index: 10;
            outline: none;
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        /* Mobile Adjustments */
        @media (max-width: 820px) {
            .main-container {
                padding: 1rem 0.5rem;
            }

            .game-header {
                margin-bottom: 1rem;
            }

            .game-title {
                font-size: 2.5rem;
            }

            .toolbar {
                margin-bottom: 1.5rem;
                gap: 0.5rem;
            }

            .puzzle-board {
                width: 100%;
            }

            .grid-cell {
                height: 90px;
            }

            .grid-number {
                font-size: 1.5rem;
            }

            .grid-inputs input,
            .grid-inputs select {
                height: 40px;
                font-size: 1rem;
            }

            .grid-inputs select {
                flex: 0 0 35px;
            }

            .strip-container {
                grid-template-columns: repeat(8, 1fr);
                margin-top: 1rem;
                gap: 1px;
            }

            .strip-cell {
                height: 45px;
            }

            .strip-cell.locked,
            .strip-input {
                font-size: 1rem;
            }

            .callout {
                margin-top: 2rem;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 2rem;
            }

            .grid-cell {
                height: 80px;
            }

            .grid-number {
                font-size: 1.25rem;
            }

            .grid-inputs input,
            .grid-inputs select {
                height: 36px;
                font-size: 0.9rem;
            }

            .grid-inputs select {
                flex: 0 0 30px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">

        <header class="game-header">
            <h1 class="game-title">Tetonor</h1>
            <div class="badge-group">
                <span id="difficulty-badge" class="badge badge-primary">MEDIUM</span>
                <span id="seed-badge" class="badge badge-secondary">Seed: 1</span>
            </div>
        </header>

        <nav class="toolbar">
            <div class="btn-group">
                <button id="diff-easy" class="btn btn-outline">Easy</button>
                <button id="diff-medium" class="btn btn-outline active">Medium</button>
                <button id="diff-hard" class="btn btn-outline">Hard</button>
            </div>
            <div class="btn-group">
                <button id="prev-btn" class="btn btn-dark">&larr; Prev</button>
                <button id="next-btn" class="btn btn-dark">Next &rarr;</button>
            </div>
            <div class="btn-group">
                <button id="reset-btn" class="btn btn-danger">‚Ü∫ Reset</button>
                <button id="solve-btn" class="btn btn-info">‚ú® Solve</button>
            </div>
            <button id="check-btn" class="btn btn-success">‚úì Check Solution</button>
        </nav>

        <section class="puzzle-board">
            <div id="grid" class="grid-container"></div>
            <div id="strip" class="strip-container"></div>
        </section>

        <aside class="callout">
            <h6 class="callout-title">How to Play</h6>
            <ul class="callout-list">
                <li>üìã <strong>Objective:</strong> Form the 16 grid numbers using 8 pairs from the strip.</li>
                <li>‚ûï <strong>Equations:</strong> Each grid number = (Number A) <strong>+</strong> or <strong>√ó</strong>
                    (Number B).</li>
                <li>üîÑ <strong>The Twice Rule:</strong> Each pair must be used <strong>exactly twice</strong>: once for
                    addition (+) and once for multiplication (√ó).</li>
                <li>üìè <strong>Strip Order:</strong> All 16 strip numbers are <strong>sorted in ascending
                        order</strong>, numbers can be repeated.</li>
            </ul>
        </aside>
    </div>

    <!-- Core Logic Scripts -->
    <script src="generator.js"></script>
    <script src="validator.js"></script>
    <script src="solver.js"></script>

    <script>
        let currentPuzzle = null;
        let solver = new TetonorSolver();
        const ALPHA = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_";

        // URL Hash Management
        function parseHash() {
            const hash = window.location.hash.slice(1);
            const params = hash.split('/');
            let difficulty = params[0] || 'medium';
            if (!['easy', 'medium', 'hard'].includes(difficulty)) difficulty = 'medium';
            const seed = parseInt(params[1]) || 1;
            const state = params[2] || null;
            return { seed, difficulty, state };
        }

        function updateHash(seed, difficulty, state = null) {
            let hash = `${difficulty}/${seed}`;
            if (state) hash += `/${state}`;
            window.location.hash = hash;
        }

        // State Serialization (Sparse Map)
        function encodeState() {
            const inputs = [];
            // Collect strip
            for (let i = 0; i < 16; i++) {
                const el = document.querySelector(`[data-strip-index="${i}"]`);
                inputs.push(el ? el.value : "");
            }
            // Collect grid (16 cells * 3 inputs each)
            for (let i = 0; i < 16; i++) {
                inputs.push(
                    document.querySelector(`[data-grid-index="${i}"][data-input-type="num1"]`).value,
                    document.querySelector(`[data-grid-index="${i}"][data-input-type="op"]`).value,
                    document.querySelector(`[data-grid-index="${i}"][data-input-type="num2"]`).value
                );
            }

            const sparse = [];
            inputs.forEach((val, i) => {
                if (val && val !== "") {
                    let v = val;
                    if (v === "+") v = "p";
                    if (v === "√ó") v = "m";
                    sparse.push(ALPHA[i] + v);
                }
            });
            return sparse.join(".");
        }

        function decodeState(encoded) {
            if (!encoded) return null;
            try {
                const state = { s: Array(16).fill(""), g: Array(48).fill("") };
                encoded.split(".").forEach(pair => {
                    const index = ALPHA.indexOf(pair[0]);
                    let val = pair.slice(1);
                    if (val === "p") val = "+";
                    if (val === "m") val = "√ó";
                    if (index < 16) state.s[index] = val;
                    else if (index < 64) state.g[index - 16] = val;
                });
                return state;
            } catch (e) { return null; }
        }

        function saveState() {
            if (!currentPuzzle) return;
            const { seed, difficulty } = parseHash();
            const encoded = encodeState();
            localStorage.setItem(`tetonor_${difficulty}_${seed}`, encoded);
            // Silent URL update (doesn't trigger hashchange)
            history.replaceState(null, null, `#${difficulty}/${seed}${encoded ? '/' + encoded : ''}`);
        }

        function loadState() {
            if (!currentPuzzle) return;
            const { seed, difficulty, state: urlState } = parseHash();
            const encoded = urlState || localStorage.getItem(`tetonor_${difficulty}_${seed}`);

            if (encoded) {
                const state = decodeState(encoded);
                if (!state) return;
                // Fill strip
                state.s.forEach((val, i) => {
                    const input = document.querySelector(`[data-strip-index="${i}"]`);
                    if (input) input.value = val;
                });
                // Fill grid
                const types = ["num1", "op", "num2"];
                state.g.forEach((val, i) => {
                    const idx = Math.floor(i / 3);
                    const type = types[i % 3];
                    const input = document.querySelector(`[data-grid-index="${idx}"][data-input-type="${type}"]`);
                    if (input) input.value = val;
                });
            }
        }

        // Rendering Functions
        function renderGrid() {
            const container = document.getElementById('grid');
            container.innerHTML = currentPuzzle.grid.map((val, i) => `
                <div class="grid-cell">
                    <div class="grid-number">${val}</div>
                    <div class="grid-inputs">
                        <input type="number" data-grid-index="${i}" data-input-type="num1">
                        <select data-grid-index="${i}" data-input-type="op">
                            <option value=""></option>
                            <option value="+">+</option>
                            <option value="√ó">√ó</option>
                        </select>
                        <input type="number" data-grid-index="${i}" data-input-type="num2">
                    </div>
                </div>
            `).join('');
            container.querySelectorAll('input, select').forEach(el => el.addEventListener('input', saveState));
        }

        function renderStrip() {
            const container = document.getElementById('strip');
            container.innerHTML = currentPuzzle.strip.map((val, i) => {
                if (val !== null) {
                    return `<div class="strip-cell locked">${val}</div>`;
                } else {
                    return `
                    <div class="strip-cell">
                        <input type="number" data-strip-index="${i}" class="strip-input">
                    </div>`;
                }
            }).join('');
            container.querySelectorAll('input').forEach(el => el.addEventListener('input', saveState));
        }

        function renderPuzzle() {
            const { seed, difficulty } = parseHash();
            const gen = new TetonorGenerator(seed);
            currentPuzzle = gen.generate(difficulty);

            // Update UI Badges
            document.getElementById('difficulty-badge').textContent = difficulty;
            document.getElementById('seed-badge').textContent = `Seed: ${seed}`;

            // Update Toolbar Active State
            document.querySelectorAll('.btn-outline').forEach(btn => {
                btn.classList.toggle('active', btn.id === `diff-${difficulty}`);
            });

            renderGrid();
            renderStrip();
            loadState();
        }

        // Action Handlers
        function checkSolution() {
            const stripInputs = [];
            currentPuzzle.strip.forEach((val, i) => {
                if (val === null) {
                    stripInputs[i] = parseInt(document.querySelector(`[data-strip-index="${i}"]`).value);
                } else {
                    stripInputs[i] = null;
                }
            });

            const gridInputs = [];
            for (let i = 0; i < 16; i++) {
                gridInputs.push({
                    num1: parseInt(document.querySelector(`[data-grid-index="${i}"][data-input-type="num1"]`).value),
                    op: document.querySelector(`[data-grid-index="${i}"][data-input-type="op"]`).value,
                    num2: parseInt(document.querySelector(`[data-grid-index="${i}"][data-input-type="num2"]`).value)
                });
            }

            const result = TetonorValidator.validate(currentPuzzle, { stripInputs, gridInputs });

            // Apply Feedback
            result.stripFeedback.forEach(f => {
                const el = document.querySelector(`[data-strip-index="${f.index}"]`);
                if (el) { el.classList.toggle('correct', f.correct); el.classList.toggle('incorrect', !f.correct); }
            });

            result.gridFeedback.forEach(f => {
                ['num1', 'op', 'num2'].forEach(t => {
                    const el = document.querySelector(`[data-grid-index="${f.index}"][data-input-type="${t}"]`);
                    el.classList.toggle('correct', f.correct); el.classList.toggle('incorrect', !f.correct);
                });
            });

            alert(TetonorValidator.formatErrorMessage(result));
        }

        // Initialize HUD
        document.getElementById('prev-btn').onclick = () => {
            const state = parseHash();
            updateHash(Math.max(1, state.seed - 1), state.difficulty);
        };
        document.getElementById('next-btn').onclick = () => {
            const state = parseHash();
            updateHash(state.seed + 1, state.difficulty);
        };
        document.getElementById('reset-btn').onclick = () => {
            if (confirm("Reset progress for this puzzle?")) {
                const state = parseHash();
                localStorage.removeItem(`tetonor_${state.difficulty}_${state.seed}`);
                updateHash(state.seed, state.difficulty);
                renderPuzzle();
            }
        };
        document.getElementById('check-btn').onclick = checkSolution;
        document.getElementById('solve-btn').onclick = () => {
            const btn = document.getElementById('solve-btn');
            const solution = solver.solve(currentPuzzle.grid, currentPuzzle.strip);
            if (solution) {
                solution.strip.forEach((v, i) => {
                    const el = document.querySelector(`[data-strip-index="${i}"]`);
                    if (el) el.value = v;
                });
                solution.grid.forEach((c, i) => {
                    document.querySelector(`[data-grid-index="${i}"][data-input-type="num1"]`).value = c.num1;
                    document.querySelector(`[data-grid-index="${i}"][data-input-type="op"]`).value = c.op;
                    document.querySelector(`[data-grid-index="${i}"][data-input-type="num2"]`).value = c.num2;
                });
                saveState();
            } else { alert("Could not solve."); }
        };

        ['easy', 'medium', 'hard'].forEach(d => {
            document.getElementById(`diff-${d}`).onclick = () => {
                const state = parseHash();
                updateHash(state.seed, d);
            };
        });

        window.onhashchange = renderPuzzle;
        renderPuzzle();

    </script>
</body>

</html>